---

- hosts: virt:&kvm
  roles:
    - name: virtual/libvirt
      become: true
  tasks:
    - name: ensure permissions unchecked for tf storage
      become: true
      ansible.builtin.lineinfile:
        path: /etc/libvirt/qemu.conf
        regexp: "^#security_driver = .*$"
        line: 'security_driver = "none"'
      notify: restart libvirtd

  handlers:
    - name: restart libvirtd
      become: true
      ansible.builtin.systemd_service:
        name: libvirtd.service
        state: restarted

- hosts: virt:&lxd
  roles:
    - name: virtual/lxd

- hosts: virt:&docker
  roles:
    - role: os/linux/docker
      become: true
      vars:
        docker_users:
          - "{{ ansible_env.USER }}"

# - hosts: virt
#   gather_facts: false
#   roles:
#     - role: os/users
#       vars:
#         users_require_superuser: false
#         users_list:
#           - name: provisioner
#             groups:
#               - libvirt

- name: k8s | cluster deployment
  import_playbook: ./k8s-hw.yml
  tags:
    - k8s
    - k8s-hw

- name: k8s | app of apps 
  import_playbook: ./k8s-apps.yml
  tags:
    - k8s
    - k8s-apps
